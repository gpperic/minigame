<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Neon Snake</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
</head>
<body class="game-body">

    <h1>> NEON SNAKE</h1>

    <div class="info-panel" style="justify-content: center; gap: 20px;">
        <div class="mine-count">SCORE: <span id="score">0</span></div>
        <div class="mine-count" style="color: #fff;">HIGH: <span id="high-score">0</span></div>
    </div>

    <div class="status" id="status">PRESS START TO PLAY</div>

    <div id="snake-board"></div>

    <div class="d-pad">
        <div class="d-btn d-up" onclick="changeDirection({x: 0, y: -1})">â–²</div>
        <div class="d-btn d-left" onclick="changeDirection({x: -1, y: 0})">â—€</div>
        <div class="d-btn d-down" onclick="changeDirection({x: 0, y: 1})">â–¼</div>
        <div class="d-btn d-right" onclick="changeDirection({x: 1, y: 0})">â–¶</div>
    </div>

    <button class="game-btn" onclick="startGame()">START GAME</button>
    <a href="index.html" class="back-link"><< BACK TO MAIN</a>

    <script type="module">
        import { getAnalyticsInstance, logEvent } from './firebase-config.js';
        const analytics = await getAnalyticsInstance();

        // --- ê²Œì„ ì„¤ì • ë³€ìˆ˜ ---
        const GRID_SIZE = 20; // 20x20 ê²©ì
        const SPEED = 150;    // ê²Œì„ ì†ë„ (ë‚®ì„ìˆ˜ë¡ ë¹ ë¦„)
        
        let snake = [];
        let food = { x: 0, y: 0 };
        let direction = { x: 0, y: 0 };
        let nextDirection = { x: 0, y: 0 }; // ë¹ ë¥¸ ì…ë ¥ ë²„ê·¸ ë°©ì§€ìš©
        let gameInterval = null;
        let score = 0;
        let highScore = localStorage.getItem('snakeHighScore') || 0;
        let isGameRunning = false;

        // DOM ìš”ì†Œ
        const boardElement = document.getElementById('snake-board');
        const scoreElement = document.getElementById('score');
        const highScoreElement = document.getElementById('high-score');
        const statusElement = document.getElementById('status');

        // ì´ˆê¸°í™”
        highScoreElement.innerText = highScore;

        // ì „ì—­ í•¨ìˆ˜ ë“±ë¡ (HTML ë²„íŠ¼ì—ì„œ í˜¸ì¶œìš©)
        window.startGame = function() {
            if (isGameRunning) return;
            
            resetGame();
            isGameRunning = true;
            statusElement.innerText = "HUNT THE PIXELS!";
            statusElement.style.color = "var(--retro-text)";
            statusElement.classList.remove('blink-text');

            // ğŸ“Š ê²Œì„ ì‹œì‘ ë¶„ì„
            logEvent(analytics, 'level_start', {
                level_name: 'snake_classic',
                difficulty: 'normal'
            });

            // ê²Œì„ ë£¨í”„ ì‹œì‘
            if (gameInterval) clearInterval(gameInterval);
            gameInterval = setInterval(gameLoop, SPEED);
        };

        window.changeDirection = function(newDir) {
            if (!isGameRunning) return;
            // ë°˜ëŒ€ ë°©í–¥ìœ¼ë¡œëŠ” ì „í™˜ ë¶ˆê°€ (ì˜ˆ: ìœ„ë¡œ ê°€ëŠ”ë° ì•„ë˜ë¡œ ëª» ê°)
            if (newDir.x !== 0 && direction.x !== 0) return;
            if (newDir.y !== 0 && direction.y !== 0) return;
            
            nextDirection = newDir;
        };

        function resetGame() {
            snake = [{ x: 10, y: 10 }]; // ë±€ ì´ˆê¸° ìœ„ì¹˜ (ì¤‘ì•™)
            direction = { x: 0, y: 0 }; // ì²˜ìŒì—” ì •ì§€ ìƒíƒœ (ë˜ëŠ” ë°”ë¡œ ì›€ì§ì´ê²Œ í•˜ë ¤ë©´ {x:1, y:0})
            nextDirection = { x: 1, y: 0 }; // ì˜¤ë¥¸ìª½ìœ¼ë¡œ ì‹œì‘
            score = 0;
            updateScore();
            createBoard();
            placeFood();
        }

        function createBoard() {
            boardElement.innerHTML = '';
            for (let y = 0; y < GRID_SIZE; y++) {
                for (let x = 0; x < GRID_SIZE; x++) {
                    const cell = document.createElement('div');
                    cell.classList.add('snake-cell');
                    cell.id = `cell-${x}-${y}`;
                    boardElement.appendChild(cell);
                }
            }
            render(); // ì²« í™”ë©´ ê·¸ë¦¬ê¸°
        }

        function placeFood() {
            let valid = false;
            while (!valid) {
                food.x = Math.floor(Math.random() * GRID_SIZE);
                food.y = Math.floor(Math.random() * GRID_SIZE);
                // ë±€ ëª¸í†µ ìœ„ì— ìƒê¸°ì§€ ì•Šë„ë¡ ì²´í¬
                valid = !snake.some(segment => segment.x === food.x && segment.y === food.y);
            }
        }

        function gameLoop() {
            direction = nextDirection; // ì…ë ¥ëœ ë°©í–¥ ì ìš©

            // 1. ë¨¸ë¦¬ ìœ„ì¹˜ ê³„ì‚°
            const head = { x: snake[0].x + direction.x, y: snake[0].y + direction.y };

            // 2. ì¶©ëŒ ì²´í¬ (ë²½ ë˜ëŠ” ìê¸° ìì‹ )
            if (head.x < 0 || head.x >= GRID_SIZE || head.y < 0 || head.y >= GRID_SIZE || 
                snake.some(segment => segment.x === head.x && segment.y === head.y)) {
                gameOver();
                return;
            }

            // 3. ì´ë™ ì²˜ë¦¬ (ë¨¸ë¦¬ ì¶”ê°€)
            snake.unshift(head);

            // 4. ë¨¹ì´ ë¨¹ê¸° ì²´í¬
            if (head.x === food.x && head.y === food.y) {
                score += 10;
                updateScore();
                placeFood(); // ê¼¬ë¦¬ ìë¥´ì§€ ì•ŠìŒ (ê¸¸ì–´ì§)
            } else {
                snake.pop(); // ë¨¹ì´ ì•ˆ ë¨¹ì—ˆìœ¼ë©´ ê¼¬ë¦¬ ìë¦„ (ì´ë™ íš¨ê³¼)
            }

            render();
        }

        function render() {
            // ëª¨ë“  ì¹¸ ì´ˆê¸°í™” (ë¹„íš¨ìœ¨ì ì´ì§€ë§Œ 20x20ì´ë¼ ê´œì°®ìŒ)
            const cells = document.querySelectorAll('.snake-cell');
            cells.forEach(c => c.className = 'snake-cell');

            // ë¨¹ì´ ê·¸ë¦¬ê¸°
            const foodCell = document.getElementById(`cell-${food.x}-${food.y}`);
            if (foodCell) foodCell.classList.add('snake-food');

            // ë±€ ê·¸ë¦¬ê¸°
            snake.forEach((segment, index) => {
                const cell = document.getElementById(`cell-${segment.x}-${segment.y}`);
                if (cell) {
                    cell.classList.add('snake-body');
                    if (index === 0) cell.classList.add('snake-head'); // ë¨¸ë¦¬ í‘œì‹œ
                }
            });
        }

        function updateScore() {
            scoreElement.innerText = score;
            if (score > highScore) {
                highScore = score;
                highScoreElement.innerText = highScore;
                localStorage.setItem('snakeHighScore', highScore);
            }
        }

        function gameOver() {
            clearInterval(gameInterval);
            isGameRunning = false;
            statusElement.innerText = "GAME OVER!";
            statusElement.classList.add('blink-text');
            statusElement.style.color = "var(--retro-accent)";

            // ğŸ“Š ì ìˆ˜ ê¸°ë¡
            logEvent(analytics, 'post_score', {
                score: score,
                character: 'snake',
                level: 1
            });
        }

        // í‚¤ë³´ë“œ ì»¨íŠ¸ë¡¤ (PCìš©)
        document.addEventListener('keydown', (e) => {
            switch(e.key) {
                case 'ArrowUp': changeDirection({x: 0, y: -1}); break;
                case 'ArrowDown': changeDirection({x: 0, y: 1}); break;
                case 'ArrowLeft': changeDirection({x: -1, y: 0}); break;
                case 'ArrowRight': changeDirection({x: 1, y: 0}); break;
            }
        });

        // ì´ˆê¸° ë³´ë“œ ìƒì„± (ë¹ˆ í™”ë©´)
        createBoard();

    </script>
</body>
</html>
